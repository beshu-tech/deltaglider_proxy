name: CI

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: read

env:
  BUILDER_IMAGE: ghcr.io/${{ github.repository }}/builder:latest

jobs:
  fmt:
    name: Rustfmt
    runs-on: k3s
    container:
      image: ghcr.io/beshu-tech/deltaglider_proxy/builder:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: cargo fmt
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: k3s
    container:
      image: ghcr.io/beshu-tech/deltaglider_proxy/builder:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Build demo UI (required by rust-embed)
        run: cd demo/s3-browser/ui && npm ci && npm run build
      - name: cargo clippy
        run: cargo clippy --locked --all-targets --all-features -- -D warnings

  test:
    name: Tests
    runs-on: k3s
    container:
      image: ghcr.io/beshu-tech/deltaglider_proxy/builder:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    services:
      minio:
        image: bitnami/minio:latest
        env:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin
        ports:
          - 9000:9000
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Build demo UI (required by rust-embed)
        run: cd demo/s3-browser/ui && npm ci && npm run build
      - name: Wait for MinIO and create test buckets
        env:
          MINIO_ENDPOINT: http://minio:9000
        run: |
          for i in $(seq 1 30); do
            mc alias set local "$MINIO_ENDPOINT" minioadmin minioadmin 2>/dev/null && break
            sleep 1
          done
          mc mb --ignore-existing local/deltaglider-test
          mc mb --ignore-existing local/deltaglider-data
      - name: cargo test
        env:
          RUST_BACKTRACE: "1"
          MINIO_ENDPOINT: http://minio:9000
        run: cargo test --all --locked

  audit:
    name: RustSec Audit
    runs-on: k3s
    container:
      image: ghcr.io/beshu-tech/deltaglider_proxy/builder:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    continue-on-error: true
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: cargo audit
        run: cargo audit
