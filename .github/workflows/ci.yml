name: CI

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: read

env:
  BUILDER_IMAGE: ghcr.io/${{ github.repository }}/builder:latest

jobs:
  fmt:
    name: Rustfmt
    runs-on: k3s
    container:
      image: ghcr.io/beshu-tech/deltaglider_proxy/builder:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: cargo fmt
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: k3s
    container:
      image: ghcr.io/beshu-tech/deltaglider_proxy/builder:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Build demo UI (required by rust-embed)
        run: cd demo/s3-browser/ui && npm ci && npm run build
      - name: cargo clippy
        run: cargo clippy --locked --all-targets --all-features -- -D warnings

  test:
    name: Tests
    runs-on: k3s
    container:
      image: ghcr.io/beshu-tech/deltaglider_proxy/builder:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: Build demo UI (required by rust-embed)
        run: cd demo/s3-browser/ui && npm ci && npm run build
      - name: Start MinIO
        run: |
          # Share network namespace with the job container so MinIO is on localhost
          docker run -d --name minio-ci --network container:$(hostname) \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            minio/minio:latest server /data
          for i in $(seq 1 30); do
            mc alias set local http://localhost:9000 minioadmin minioadmin 2>/dev/null && break
            sleep 1
          done
          mc mb --ignore-existing local/deltaglider-test
          mc mb --ignore-existing local/deltaglider-data
      - name: cargo test
        env:
          RUST_BACKTRACE: "1"
        run: cargo test --all --locked
      - name: Stop MinIO
        if: always()
        run: docker rm -f minio-ci 2>/dev/null || true

  audit:
    name: RustSec Audit
    runs-on: k3s
    container:
      image: ghcr.io/beshu-tech/deltaglider_proxy/builder:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    continue-on-error: true
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - name: cargo audit
        run: cargo audit
