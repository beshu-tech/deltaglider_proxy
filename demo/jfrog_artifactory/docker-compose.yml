# Docker Compose for JFrog Artifactory Demo with DeltaGlider Proxy
#
# This setup demonstrates storage savings when using DeltaGlider Proxy
# as an S3 proxy between Artifactory Pro and MinIO.
#
# Architecture:
#   Maven Client → Artifactory Pro → DeltaGlider → MinIO
#
# Usage:
#   docker compose up -d              # Start all services
#   docker compose down -v            # Stop and remove volumes
#   docker compose logs -f            # View logs
#
# Ports:
#   - 8081: Artifactory Pro
#   - 9010: MinIO S3 API
#   - 9011: MinIO Console
#   - 9012: DeltaGlider Proxy S3 API

services:
  # MinIO - Object Storage Backend
  minio:
    image: minio/minio:latest
    container_name: demo-minio
    ports:
      - "9010:9000"   # S3 API
      - "9011:9001"   # Console
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio123
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - demo-network

  # MinIO Setup - Create buckets on startup
  minio-setup:
    image: minio/mc:latest
    container_name: demo-minio-setup
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 minio minio123;
      mc mb --ignore-existing local/artifacts;
      mc mb --ignore-existing local/deltaglider-data;
      echo 'Buckets created: artifacts, deltaglider-data';
      exit 0;
      "
    networks:
      - demo-network

  # DeltaGlider Proxy - Delta Compression S3 Proxy
  deltaglider:
    image: deltaglider-proxy:latest
    build:
      context: ../..
      dockerfile: demo/jfrog_artifactory/Dockerfile.deltaglider
    container_name: demo-deltaglider
    ports:
      - "9012:9012"
    environment:
      DELTAGLIDER_PROXY_LISTEN_ADDR: "0.0.0.0:9012"
      DELTAGLIDER_PROXY_DEFAULT_BUCKET: "default"
      DELTAGLIDER_PROXY_S3_BUCKET: "deltaglider-data"
      DELTAGLIDER_PROXY_S3_ENDPOINT: "http://minio:9000"
      DELTAGLIDER_PROXY_S3_REGION: "us-east-1"
      DELTAGLIDER_PROXY_S3_FORCE_PATH_STYLE: "true"
      DELTAGLIDER_PROXY_MAX_DELTA_RATIO: "0.8"
      DELTAGLIDER_PROXY_MAX_OBJECT_SIZE: "104857600"
      DELTAGLIDER_PROXY_CACHE_SIZE_MB: "100"
      AWS_ACCESS_KEY_ID: minio
      AWS_SECRET_ACCESS_KEY: minio123
      RUST_LOG: info
    depends_on:
      minio-setup:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9012/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - demo-network

  # JFrog Artifactory Pro (with S3 binarystore support)
  artifactory:
    image: releases-docker.jfrog.io/jfrog/artifactory-pro:7.77.5
    container_name: demo-artifactory
    ports:
      - "8081:8081"
      - "8082:8082"
    ulimits:
      nproc: 65535
      nofile:
        soft: 32000
        hard: 40000
    environment:
      JF_SHARED_DATABASE_TYPE: derby
      EXTRA_JAVA_OPTIONS: "-Xms1g -Xmx4g"
    volumes:
      - artifactory-data:/var/opt/jfrog/artifactory
      - ./artifactory.lic:/var/opt/jfrog/artifactory/etc/artifactory.lic:ro
      # Note: binarystore.xml is configured via the run_demo.sh script after first startup
    depends_on:
      minio-setup:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/artifactory/api/system/ping"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s
    networks:
      - demo-network

  # Maven Test Runner - Fetches artifacts through Artifactory
  maven-runner:
    image: maven:3.9-eclipse-temurin-17
    container_name: demo-maven-runner
    working_dir: /workspace
    volumes:
      - ./scripts:/workspace/scripts:ro
      - ./config:/workspace/config:ro
      - ./results:/workspace/results
      - maven-repo:/root/.m2/repository
    environment:
      ARTIFACTORY_URL: "http://artifactory:8081/artifactory"
      MINIO_ENDPOINT: "http://minio:9000"
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio123
    depends_on:
      artifactory:
        condition: service_healthy
      deltaglider:
        condition: service_healthy
    networks:
      - demo-network
    # Keep container running for manual execution
    command: ["tail", "-f", "/dev/null"]

volumes:
  minio-data:
  artifactory-data:
  maven-repo:

networks:
  demo-network:
    driver: bridge
